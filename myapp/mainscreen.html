<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Main Screen and Controller Device</title>
    <!-- Include necessary libraries -->
    <script src="https://zimjs.org/cdn/CreateJS_min.js"></script>
    <script src="https://zimjs.org/cdn/2.3.0/socket.io.js"></script>
    <script src="https://zimjs.org/cdn/zimserver_urls.js"></script>
    <script src="https://zimjs.org/cdn/zimsocket_1.1.js"></script>
    <script type="module">
        import zim from "https://zimjs.org/cdn/016/zim_socket";
        import zim2 from "https://zimjs.com/cdn/015/zim_game";

        new Frame(FIT, 1024, 768, light, dark, ready);

        function ready() {
            STYLE = {
                font:"InGame.ttf"
            };

            setupMainScreen();
            handleDeviceCommunications();
        }

        function setupMainScreen() {
            const mainScreenContainer = new Container(W,H).center();

            const numUsersLabel = new Label("Users: 1")
                    .center()
                    .addTo(mainScreenContainer);

            // Establish socket connection
            const appName = "pokemotion";
            const socket = new Socket(zimSocketURL, appName); 

            // Listen for socket events
            socket.on("ready", function() {
                zog("Connected to socket");
                numUsersLabel.text = "Users: " + (socket.size + 1);
                S.update();
            });

            socket.on("otherjoin", function () {
                numUsersLabel.text = "Users: " + (socket.size + 1);
                S.update();
                
                if (socket.size + 1 === 3) {
                    transitionToMainScreen();
                }
            });

            socket.on("otherleave", function () {
                numUsersLabel.text = "Users: " + (socket.size + 1);
                S.update();
            });

            socket.on("error", function () {
                numUsersLabel.text = "Error occurred";
                S.update();
            });

            // Listen for button press event on controller device
            controller.on("button", function(data) {
                // Send the button press data to the main screen
                sendInstructionToMainScreen(data.button);
            });
            
            // Listen for direction pad press event on controller device
            controller.on("dpad", function(data) {
                // Send the direction pad press data to the main screen
                sendInstructionToMainScreen(data.direction);
            });
        }

        function handleDeviceCommunications() {
               // Event listener for directional pad and button press on mobile controller for Player A
        controllerA.addEventListener('input', () => {
            const direction = controllerA.getDirection(); // Get direction from directional pad
            const buttonPressed = controllerA.getButtonState(); // Check if button A is pressed
            // Send data to main screen indicating directional pad movement and button press from Player A
            socket.setProperties({ player: 'A', direction: direction, buttonPressed: buttonPressed });
        });
        
        // Event listener for directional pad and button press on mobile controller for Player B
        controllerB.addEventListener('input', () => {
            const direction = controllerB.getDirection(); // Get direction from directional pad
            const buttonPressed = controllerB.getButtonState(); // Check if button A is pressed
            // Send data to main screen indicating directional pad movement and button press from Player B
            socket.setProperties({ player: 'B', direction: direction, buttonPressed: buttonPressed });
        });
        
        // When the socket is ready we get this event
        socket.on("ready", () => {
            // Listen for incoming data from mobile controllers
            socket.on("data", data => {
                // Check the player and action from the data received
                const player = data.player;
                const direction = data.direction;
                const buttonPressed = data.buttonPressed;
        
                // Display content on the main screen based on player actions
                if (player === 'A') {
                    if (direction === 'up') {
                        // Handle up direction for Player A
                    } else if (direction === 'down') {
                        // Handle down direction for Player A
                    } else if (direction === 'left') {
                        // Handle left direction for Player A
                    } else if (direction === 'right') {
                        // Handle right direction for Player A
                    }
                    if (buttonPressed) {
                        // Handle button press for Player A
                    }
                } else if (player === 'B') {
                    if (direction === 'up') {
                        // Handle up direction for Player B
                    } else if (direction === 'down') {
                        // Handle down direction for Player B
                    } else if (direction === 'left') {
                        // Handle left direction for Player B
                    } else if (direction === 'right') {
                        // Handle right direction for Player B
                    }
                    if (buttonPressed) {
                        // Handle button press for Player B
                    }
                }
            });
        });
        
        // Error handling
        socket.on("error", () => {
            new zim.Pane("SORRY, COULD NOT CONNECT").show();
        });
        }
    </script>
</head>
<body>
    <!-- HTML content for both the main screen and controller device can go here -->
</body>
</html>
